<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waterflow Monitor</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f6fa; }
  header { background:#0984e3; color:white; padding:15px; text-align:center; font-size:1.5em; font-weight:bold; }
  nav { display:flex; justify-content:space-around; background:#00b894; color:white; }
  nav button { background:none; border:none; color:white; padding:10px; font-size:1em; cursor:pointer; width:50%; }
  nav button.active { background:#019874; font-weight:bold; }
  main { padding:15px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden; }
  th, td { padding:12px; text-align:center; }
  th { background:#0984e3; color:white; position:sticky; top:0; }
  tr:nth-child(even) { background:#dfe6e9; }
  tr:nth-child(odd) { background:#ffffff; }
  button.refresh { background:#00b894; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-bottom:10px; }
  button.refresh:hover { background:#019874; }
  .reading { font-size:1.2em; text-align:center; margin-top:20px; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  @media only screen and (max-width:600px) { th, td { font-size:0.9em; padding:8px; } button.refresh { width:100%; font-size:1em; } }
</style>
</head>
<body>

<header>Waterflow Monitor</header>

<nav>
  <button id="homeBtn" class="active" onclick="showPage('home')">Current Reading</button>
  <button id="historyBtn" onclick="showPage('history')">History</button>
</nav>

<main>
  <!-- Homepage -->
  <div id="homePage">
    <button class="refresh" onclick="loadCurrentReading()">Refresh</button>
    <div id="currentReading" class="reading">Loading latest reading...</div>
  </div>

  <!-- History Page -->
  <div id="historyPage" style="display:none;">
    <button class="refresh" onclick="loadHistory()">Refresh</button>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Weekday</th>
          <th>Time</th>
          <th>Occurrences</th>
          <th>Sum Liters</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
const firebaseURL = "https://hello-f1194-default-rtdb.firebaseio.com/mobile_app/rows.json";

// Navigation
function showPage(page) {
  document.getElementById('homePage').style.display = page === 'home' ? 'block' : 'none';
  document.getElementById('historyPage').style.display = page === 'history' ? 'block' : 'none';
  document.getElementById('homeBtn').classList.toggle('active', page==='home');
  document.getElementById('historyBtn').classList.toggle('active', page==='history');
}

// Load latest reading (by timestamp)
async function loadCurrentReading() {
  const div = document.getElementById('currentReading');
  div.textContent = "Loading latest reading...";
  try {
    const res = await fetch(firebaseURL);
    const data = await res.json();
    if (!data || data.length === 0) {
      div.textContent = "No readings available.";
      return;
    }

    // Find the latest record by timestamp
    const latest = data.reduce((prev, current) => {
        if (!prev.minute_start_iso) return current;
        if (!current.minute_start_iso) return prev;
        return new Date(prev.minute_start_iso) > new Date(current.minute_start_iso) ? prev : current;
    });

    div.innerHTML = `
      <strong>${latest.weekday_name} ${latest.time_hmm}</strong><br>
      Total Liters: ${Number(latest.sum_liters).toFixed(3)}<br>
      Occurrences: ${latest.occurrences}
    `;
  } catch (err) {
    div.textContent = "Error loading reading: " + err;
  }
}

// Load history table
async function loadHistory() {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";
  try {
    const res = await fetch(firebaseURL);
    const data = await res.json();
    if (!data || data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No data available</td></tr>";
      return;
    }
    tbody.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.weekday_name}</td>
        <td>${row.time_hmm}</td>
        <td>${row.occurrences}</td>
        <td>${Number(row.sum_liters).toFixed(3)}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan='4'>Error loading data: ${err}</td></tr>`;
  }
}

// Initial load
window.onload = () => {
  loadCurrentReading();
  loadHistory();
  // Auto-refresh every 60 seconds
  setInterval(() => { loadCurrentReading(); loadHistory(); }, 60000);
};
</script>

</body>
</html>
